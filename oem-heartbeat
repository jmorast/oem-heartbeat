#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

export PATH=/usr/local/bin:/usr/bin:/bin

# ===================== CONFIG =====================
# Unique healthcheck URL for this site/client
HC_URL="${HC_URL:-}"

# Oracle DB Setup
export ORACLE_SID="${ORACLE_SID:-}"
export ORAENV_ASK=NO
. /usr/local/bin/oraenv -s

# Oracle oms install paths
OMS_HOME="${OMS_HOME:-/u01/app/oracle/middleware24/oms_home}"
AGENT_HOME="${AGENT_HOME:-/u01/app/oracle/agent24/agent_inst}"

# Direct paths to binaries
EMCTL_OMS="$OMS_HOME/bin/emctl"
EMCTL_AGENT="$AGENT_HOME/bin/emctl"
SQLPLUS="$ORACLE_HOME/bin/sqlplus"

# DB connect (use OS auth by default; or "user/pw@host:1521/service")
EMREP_CONNECT="${EMREP_CONNECT:-/ as sysdba}"

# Timeouts (seconds)
EMCTL_TIMEOUT="${EMCTL_TIMEOUT:-10}"
SQLPLUS_TIMEOUT="${SQLPLUS_TIMEOUT:-10}"
CURL_TIMEOUT="${CURL_TIMEOUT:-10}"
VERSION="1.1.0"
RETRIES="${RETRIES:-3}"
RETRY_DELAY="${RETRY_DELAY:-2}"
# ==================================================

log() { echo "[$(date +'%Y-%m-%dT%H:%M:%S%z')] $*"; }

# retry wrapper: run the given command up to $RETRIES times with $RETRY_DELAY between attempts.
# Calls are executed in the current shell context, so functions can be passed by name.
retry() {
    local attempt=1
    local out
    while [ "$attempt" -le "$RETRIES" ]; do
        if out=$("$@" 2>&1); then
            echo "$out"
            return 0
        else
            local rc=$?
            log "Attempt ${attempt}/${RETRIES} failed for: $* (rc=$rc)"
            echo "$out"
            if [ "$attempt" -lt "$RETRIES" ]; then
                sleep "$RETRY_DELAY"
            fi
            attempt=$((attempt + 1))
        fi
    done
    return 1
}

die() {
    log "Failure: $*"
    curl -fsS -m "$CURL_TIMEOUT" "${HC_URL%/}/fail" >/dev/null || true
    exit 1
}
need() { [ -x "$1" ] || die "Missing or not executable: $1"; }

need "$EMCTL_OMS"
need "$EMCTL_AGENT"
need "$SQLPLUS"
command -v timeout >/dev/null 2>&1 || die "Missing command: timeout"
command -v curl >/dev/null 2>&1 || die "Missing command: curl"

[ -n "$HC_URL" ] || die "HC_URL is not set"

check_oms() {
    log "OMS check using $EMCTL_OMS"
    local out
    out=$(timeout "${EMCTL_TIMEOUT}s" "$EMCTL_OMS" status oms 2>&1) || {
        echo "$out"
        return 1
    }
    # 13.5: "is running", 24ai: "is Up"
    if ! grep -Eqi 'Oracle Management Server .* (running|up)' <<<"$out"; then
        echo "$out"
        return 1
    fi
}

check_agent() {
    log "Agent check using $EMCTL_AGENT"
    local out rc
    if ! out=$(timeout "${EMCTL_TIMEOUT}s" "$EMCTL_AGENT" status agent 2>&1); then
        rc=$?
        log "Agent status command failed (rc=$rc)"
        case $rc in
            124) log "Timeout: agent command exceeded ${EMCTL_TIMEOUT}s" ;;
            127) log "emctl binary missing or not executable: $EMCTL_AGENT" ;;
            *)   log "emctl returned error — see output below:" ;;
        esac

        # If the status output indicates the agent is not running, attempt a single start and re-check.
        if grep -qi "Agent is Not Running" <<<"$out"; then
            log "Agent is Not Running — attempting to start agent"
            start_out=$(timeout "${EMCTL_TIMEOUT}s" "$EMCTL_AGENT" start agent 2>&1) || {
                echo "$start_out"
                log "Failed to start agent"
                echo "$out"
                return 1
            }
            echo "$start_out"
            # re-check status after start attempt
            sleep 2
            if ! out=$(timeout "${EMCTL_TIMEOUT}s" "$EMCTL_AGENT" status agent 2>&1); then
                echo "$out"
                return 1
            fi
        else
            echo "$out"
            return 1
        fi
    fi

    # Normalize and evaluate output
    if grep -Eqi "Agent (is )?(Running|Up|Ready)" <<<"$out"; then
        echo "$out"
        return 0
    else
        log "Agent appears unhealthy. Raw output:"
        echo "$out" | sed 's/^/    /'
        # Some common indicators
        grep -qi "blocked|not able to connect|invalid" <<<"$out" && \
            log "Hint: Agent may be blocked, misconfigured, or unable to reach OMS."
        return 1
    fi
}

check_db_open() {
   log "EMREP open check using $SQLPLUS"
   local out
   if ! out=$(timeout "${SQLPLUS_TIMEOUT}s" "$SQLPLUS" -L -s ${EMREP_CONNECT} <<'SQL'
set pages 0 feed off ver off echo off
select case when open_mode like 'READ%' then 'OPEN' else open_mode end from v$database;
SQL
   ); then
         echo "$out"
       return 1
  fi
  grep -q "OPEN" <<<"$out" || { echo "$out"; return 1; }
}


main() {
    log "oem-heartbeat $VERSION"

    retry check_oms || die "OMS not healthy"
    retry check_agent || die "Agent not healthy"
    retry check_db_open || die "EMREP not OPEN"

    log "All good → pinging healthcheck"
    # Retry the healthcheck ping itself as it may fail transiently
    if ! response=$(retry curl -m "$CURL_TIMEOUT" "$HC_URL" 2>&1); then
        echo "$response"
        die "Healthcheck ping failed after ${RETRIES} attempts"
    fi
    echo "$response"
    log "Ping sent"
}

main "$@"
